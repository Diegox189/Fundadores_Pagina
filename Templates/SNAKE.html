<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Snake en JavaScript</title>
<style>
  :root{
    --bg:#0f1220;
    --panel:#171b2e;
    --accent:#5ef38c;
    --accent-2:#28c76f;
    --grid:#232846;
    --text:#e6e9ef;
    --muted:#9aa4b2;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    min-height:100vh;
    display:grid;
    place-items:center;
    background: radial-gradient(1000px 600px at 70% -20%, #1b2142 0%, var(--bg) 60%);
    color:var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
  }
  .wrap{
    width:min(96vw, 720px);
    display:grid;
    gap:12px;
  }
  header{
    display:flex;align-items:center;justify-content:space-between;
    gap:8px;padding:10px 12px;background:color-mix(in srgb,var(--panel),#000 10%);
    border:1px solid #202544;border-radius:14px;
    box-shadow: 0 6px 20px rgba(0,0,0,.25);
  }
  .stats{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .pill{
    background:#101427;border:1px solid #202544;border-radius:999px;
    padding:6px 10px;font-weight:600;letter-spacing:.2px
  }
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  button{
    background:linear-gradient(180deg,var(--accent) 0%, var(--accent-2) 100%);
    color:#0a0f1c;border:none;border-radius:10px;padding:8px 12px;font-weight:700;
    cursor:pointer; box-shadow:0 6px 14px rgba(40,199,111,.35);
  }
  button.secondary{
    background:#12172b;color:var(--text);border:1px solid #283056;box-shadow:none;font-weight:600
  }
  canvas{
    width:100%;aspect-ratio:1/1;background:
      linear-gradient(transparent 0, transparent 100%),
      repeating-linear-gradient(0deg, var(--grid) 0 1px, transparent 1px 32px),
      repeating-linear-gradient(90deg, var(--grid) 0 1px, transparent 1px 32px);
    border:1px solid #202544;border-radius:14px;
    box-shadow:inset 0 0 0 1px #202544, 0 12px 30px rgba(0,0,0,.35);
    image-rendering: pixelated;
    touch-action:none;
  }
  .hint{
    text-align:center;color:var(--muted);font-size:.9rem
  }
  /* Controles t√°ctiles */
  .touch{
    display:grid;gap:10px;place-items:center;margin-top:6px;
    user-select:none;
  }
  .dpad{
    display:grid;grid-template-columns:repeat(3,56px);grid-template-rows:repeat(3,56px);
    gap:8px;align-items:center;justify-items:center;
  }
  .dpad button{
    width:56px;height:56px;border-radius:14px;background:#12172b;border:1px solid #2b335e;
    color:var(--text);box-shadow: none;font-size:20px;font-weight:800
  }
  .dpad button:active{transform:scale(.98)}
  .dpad .blank{visibility:hidden}
  @media (min-width:800px){
    .touch{display:none}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="stats">
        <span class="pill">Puntos: <span id="score">0</span></span>
        <span class="pill">R√©cord: <span id="best">0</span></span>
        <span class="pill">Velocidad: <span id="speed">1</span>x</span>
      </div>
      <div class="controls">
        <button id="playBtn">‚ñ∂Ô∏è Jugar</button>
        <button id="pauseBtn" class="secondary">‚è∏ Pausa (P)</button>
        <button id="resetBtn" class="secondary">üîÅ Reiniciar</button>
      </div>
    </header>

    <canvas id="game" width="480" height="480" aria-label="Tablero del juego Snake"></canvas>
    <div class="hint">Usa ‚Üê ‚Üë ‚Üí ‚Üì o WASD. Pausa con P. Evita chocar contigo o los bordes.</div>

    <!-- Controles t√°ctiles -->
    <div class="touch">
      <div class="dpad">
        <span class="blank"></span>
        <button data-dir="up">‚ñ≤</button>
        <span class="blank"></span>

        <button data-dir="left">‚óÄ</button>
        <span class="blank"></span>
        <button data-dir="right">‚ñ∂</button>

        <span class="blank"></span>
        <button data-dir="down">‚ñº</button>
        <span class="blank"></span>
      </div>
    </div>
  </div>

<script>
(() => {
  // ----- Configuraci√≥n -----
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');

  // El tablero es una grilla cuadrada. Cambia GRID para celdas m√°s grandes.
  const GRID = 24;              // tama√±o de celda en px (debe dividir el tama√±o del canvas)
  const COLS = canvas.width / GRID;
  const ROWS = canvas.height / GRID;

  const BASE_SPEED = 7;         // ticks por segundo iniciales
  const SPEED_STEP_SCORE = 5;   // cada cu√°ntos puntos sube la velocidad
  const SPEED_INC = 0.7;        // incremento por nivel

  // Colores
  const COLOR_SNAKE = '#5ef38c';
  const COLOR_HEAD  = '#a6ffcb';
  const COLOR_FOOD  = '#ff5d7d';

  // UI
  const scoreEl = document.getElementById('score');
  const bestEl  = document.getElementById('best');
  const speedEl = document.getElementById('speed');
  const playBtn = document.getElementById('playBtn');
  const pauseBtn= document.getElementById('pauseBtn');
  const resetBtn= document.getElementById('resetBtn');

  const dpad = document.querySelector('.dpad');
  const bestKey = 'snake-best-v1';

  // ----- Estado -----
  let snake, dir, nextDir, food, score, best, running, paused, lastTime, acc, tickRate;

  function init() {
    snake = [
      {x: Math.floor(COLS/2), y: Math.floor(ROWS/2)},
      {x: Math.floor(COLS/2)-1, y: Math.floor(ROWS/2)},
      {x: Math.floor(COLS/2)-2, y: Math.floor(ROWS/2)}
    ];
    dir = {x:1,y:0};
    nextDir = {...dir};
    food = spawnFood();
    score = 0;
    best = Number(localStorage.getItem(bestKey) || 0);
    running = false;
    paused = false;
    lastTime = 0;
    acc = 0;
    tickRate = BASE_SPEED;
    updateUI();
    draw(); // dibuja estado inicial
  }

  function updateUI() {
    scoreEl.textContent = score;
    bestEl.textContent = best;
    const level = 1 + Math.floor(score / SPEED_STEP_SCORE);
    const speed = (BASE_SPEED + (level-1) * SPEED_INC).toFixed(1);
    speedEl.textContent = speed;
  }

  function spawnFood() {
    let fx, fy, valid=false;
    while(!valid){
      fx = Math.floor(Math.random()*COLS);
      fy = Math.floor(Math.random()*ROWS);
      valid = !snake.some(s => s.x===fx && s.y===fy);
    }
    return {x:fx, y:fy};
  }

  // ----- Juego -----
  function start() {
    if (running && paused){ paused=false; return; }
    if (!running){
      running = true; paused=false; lastTime=0; acc=0;
      requestAnimationFrame(loop);
    }
  }

  function pause() {
    if (!running) return;
    paused = !paused;
  }

  function reset() {
    init();
  }

  function loop(ts){
    if (!running) return;
    if (!lastTime) lastTime = ts;
    const delta = (ts - lastTime) / 1000;
    lastTime = ts;

    if (!paused){
      // velocidad escala con score
      const level = 1 + Math.floor(score / SPEED_STEP_SCORE);
      tickRate = BASE_SPEED + (level-1)*SPEED_INC;
      acc += delta;
      const step = 1 / tickRate;

      while (acc >= step) {
        acc -= step;
        stepGame();
      }
    }

    draw();
    requestAnimationFrame(loop);
  }

  function stepGame(){
    // aplicar nuevo dir (evitar giro 180¬∞ en el mismo tick)
    dir = validateDirChange(dir, nextDir);

    // nueva cabeza
    const head = {x: snake[0].x + dir.x, y: snake[0].y + dir.y};

    // colisiones paredes
    if (head.x < 0 || head.x >= COLS || head.y < 0 || head.y >= ROWS){
      gameOver(); return;
    }
    // colisi√≥n consigo mismo
    if (snake.some(seg => seg.x===head.x && seg.y===head.y)){
      gameOver(); return;
    }

    snake.unshift(head); // avanza

    // comer
    if (head.x === food.x && head.y === food.y){
      score++;
      if (score > best){
        best = score;
        localStorage.setItem(bestKey, String(best));
      }
      food = spawnFood();
      updateUI();
    } else {
      snake.pop(); // no comi√≥, quitar cola
    }
  }

  function gameOver(){
    running = false;
    paused = false;
    // animaci√≥n simple de "flash"
    flashBoard();
  }

  // ----- Dibujo -----
  function draw(){
    // limpiar
    ctx.clearRect(0,0,canvas.width, canvas.height);

    // comida
    drawCell(food.x, food.y, COLOR_FOOD, 6);

    // serpiente
    snake.forEach((seg, i) => {
      const isHead = i===0;
      drawCell(seg.x, seg.y, isHead ? COLOR_HEAD : COLOR_SNAKE, isHead ? 5 : 8);
    });

    if (!running){
      drawCenterText('SNAKE', 46, '#ffffffdd', 0, 2);
      drawCenterText('Pulsa ‚ñ∂Ô∏è o ESPACIO para jugar', 16, '#ffffff99', 28);
    } else if (paused){
      drawCenterText('PAUSA', 42, '#ffffffdd', 0, 2);
      drawCenterText('Pulsa P para continuar', 16, '#ffffff99', 28);
    }
  }

  function drawCell(cx, cy, color, pad=6){
    const x = cx*GRID, y = cy*GRID, s = GRID;
    // base
    ctx.fillStyle = color;
    ctx.beginPath();
    const r = Math.max(4, Math.floor(GRID/3));
    roundRect(ctx, x+pad/2, y+pad/2, s-pad, s-pad, r);
    ctx.fill();

    // brillo
    ctx.globalAlpha = .18;
    ctx.fillStyle = '#fff';
    roundRect(ctx, x+pad/2, y+pad/2, s-pad, (s-pad)/2, r);
    ctx.fill();
    ctx.globalAlpha = 1;
  }

  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  function drawCenterText(text, size=24, color='#fff', yOffset=0, shadow=0){
    ctx.save();
    ctx.fillStyle = color;
    ctx.font = `700 ${size}px/1.2 system-ui, Segoe UI, Roboto, Arial`;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    const cx = canvas.width/2, cy = canvas.height/2 + yOffset;
    if (shadow>0){
      ctx.shadowColor = 'rgba(0,0,0,.5)';
      ctx.shadowBlur = 10;
      ctx.shadowOffsetY = 2;
    }
    ctx.fillText(text, cx, cy);
    ctx.restore();
  }

  async function flashBoard() {
    // breve parpadeo para indicar fin
    for (let i=0;i<2;i++){
      await wait(70); canvas.style.filter='brightness(1.5)';
      await wait(70); canvas.style.filter='';
    }
  }
  const wait = (ms)=>new Promise(r=>setTimeout(r,ms));

  // ----- Controles -----
  function validateDirChange(curr, next){
    // Evita reversa inmediata (p.ej., derecha -> izquierda)
    if (curr.x !== 0 && next.x !== 0) return curr;
    if (curr.y !== 0 && next.y !== 0) return curr;
    return next;
  }

  function setDirectionByKey(key){
    const k = key.toLowerCase();
    if (k==='arrowup' || k==='w') nextDir = {x:0,y:-1};
    else if (k==='arrowdown' || k==='s') nextDir = {x:0,y:1};
    else if (k==='arrowleft' || k==='a') nextDir = {x:-1,y:0};
    else if (k==='arrowright' || k==='d') nextDir = {x:1,y:0};
  }

  window.addEventListener('keydown', (e) => {
    if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '].includes(e.key)) e.preventDefault();
    if (e.key === ' '){ start(); return; }
    if (e.key.toLowerCase() === 'p'){ pause(); return; }
    setDirectionByKey(e.key);
  }, {passive:false});

  // Botones UI
  playBtn.addEventListener('click', start);
  pauseBtn.addEventListener('click', pause);
  resetBtn.addEventListener('click', reset);

  // D-pad t√°ctil
  if (dpad){
    dpad.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-dir]');
      if(!btn) return;
      const d = btn.getAttribute('data-dir');
      if (d==='up') nextDir = {x:0,y:-1};
      if (d==='down') nextDir = {x:0,y:1};
      if (d==='left') nextDir = {x:-1,y:0};
      if (d==='right') nextDir = {x:1,y:0};
      start();
    });
  }

  // Deslizar para m√≥vil (swipes)
  let touchStart = null;
  canvas.addEventListener('touchstart', (e)=>{
    if (e.touches.length===1){
      touchStart = {x:e.touches[0].clientX, y:e.touches[0].clientY};
    }
  }, {passive:true});
  canvas.addEventListener('touchmove', (e)=>{ e.preventDefault(); }, {passive:false});
  canvas.addEventListener('touchend', (e)=>{
    if (!touchStart) return;
    const t = e.changedTouches[0];
    const dx = t.clientX - touchStart.x;
    const dy = t.clientY - touchStart.y;
    const ax = Math.abs(dx), ay = Math.abs(dy);
    if (Math.max(ax, ay) > 24){
      if (ax > ay){
        nextDir = {x: dx>0 ? 1 : -1, y:0};
      } else {
        nextDir = {x:0, y: dy>0 ? 1 : -1};
      }
      start();
    }
    touchStart = null;
  }, {passive:true});

  // Iniciar
  init();
})();
</script>
</body>
</html>
